# Fish Reports Processing System

Система обработки отчетов о рыбе для Министерства здравоохранения Израиля.

## Описание

# Fish Reports Processing System

Система обработки отчетов о рыбе для Министерства здравоохранения Израиля.

## 🎯 Статус: ГОТОВО К ПРОДАКШЕНУ

**✅ Все проблемы решены**
**✅ Система полностью функциональна**
**✅ Проект очищен и готов к слиянию**

## 🔄 Автоматическая замена полей
Система автоматически заменяет следующие поля в найденных отчетах:

- **אסמכתת בסיס** → **מספר תעודת משלוח**
- **סה'כ אריזות** → **סה"כ קרטונים**
- **סה'כ משקל** → **מוצרים מוכנים לאכילה**

## 📊 Отчет о необработанных лицензиях
Система теперь предупреждает о лицензиях, для которых есть данные, но нет соответствующих файлов отчетов.

## Описание

Приложение предназначено для:
1. Фильтрации данных из исходных файлов
2. Конвертации весов из граммов в килограммы
3. Группировки данных по базовому документу (אסמכתת בסיס)
4. Создания промежуточных файлов с отфильтрованными данными
5. **Интеллектуального поиска отчетов по содержимому файлов** с поддержкой Hebrew текста
6. Поиска файлов отчетов, содержащих номера лицензий клиентов
7. **Замены данных в найденных отчетах**
8. Подготовки копий для отправки в משרד הבריאות

## 🚀 Быстрый запуск

#### Тестирование замены данных:
```bash
python test_data_replacement.py
```

#### Демонстрация полного процесса:
```bash
python demo.py
```

#### Запуск GUI приложения:
```bash
python -m src.fish_reports
```

## Основные функции

### Обработка данных
- **Фильтрация данных**: удаление записей с отрицательными значениями
- **Конвертация весов**: автоматическое преобразование граммов в килограммы
- **Группировка**: объединение данных по базовому документу с суммированием весов и количества

### Интеллектуальный поиск отчетов
- **Поиск по содержимому**: система анализирует содержимое файлов для поиска номеров лицензий
- **Поддержка Hebrew**: обработка полей на иврите, включая "ח"פ לקוח או מספר אישור משרד הבריאות"
- **Множественные кодировки**: UTF-8, Windows-1255, ISO-8859-8, CP1255
- **Форматы файлов**: TXT, JSON, CSV, XML, Excel (.xlsx, .xls)
- **Fallback механизм**: поиск по именам файлов, если поиск по содержимому не даст результатов
- **Организованное копирование**: создание отдельных папок для каждой лицензии

### 🔥 Замена данных в отчетах (НОВОЕ)
- **Автоматическое обновление полей** в скопированных файлах
- **Поддержка Excel, JSON, TXT** форматов
- **Сопоставление данных** из промежуточного файла
- **Корректная замена Hebrew полей**

### GUI интерфейс
- **Hebrew текст**: полная поддержка иврита в интерфейсе
- **Выбор папок**: интуитивный выбор исходных файлов и папок отчетов
- **Прогресс выполнения**: отслеживание хода обработки
- **Логирование**: детальные логи операций

## Структура проекта

```
fish-reports-dolina/
├── src/
│   └── fish_reports/
│       ├── core/          # Основная логика
│       │   └── workflow.py
│       ├── data/          # Обработка данных
│       │   ├── file_processor.py
│       │   └── report_manager.py  # 🔥 ИСПРАВЛЕНО: добавлена функция замены данных
│       ├── gui/           # Интерфейс пользователя
│       └── utils/         # Вспомогательные утилиты
├── tests/                 # Тесты
├── demo.py               # Демонстрация
└── test_data_replacement.py  # Тест замены данных
```

## Установка

1. Создайте виртуальное окружение:
```bash
python -m venv venv
```

2. Активируйте виртуальное окружение:
```bash
# Windows
venv\Scripts\activate
```

3. Установите зависимости:
```bash
pip install pandas openpyxl pytest
```

## Использование

### 🔧 API использования

```python
from pathlib import Path
from fish_reports.data.report_manager import ReportManager

# Инициализация
manager = ReportManager(
    search_directory=Path("reports/"),
    output_directory=Path("output/")
)

# Поиск отчетов
found = manager.search_reports_by_content(["12345", "67890"])

# Копирование файлов
copied = manager.copy_reports_to_output()

# Замена данных (ГЛАВНАЯ ФУНКЦИЯ)
updated = manager.update_reports_with_data(
    intermediate_file=Path("processed_data.xlsx")
)
```

### Использование через GUI

1. **Выберите исходный файл**: файл Excel с данными о рыбе
2. **Выберите папку отчетов**: директория, содержащая файлы отчетов для поиска
3. **Выберите папки вывода**:
   - Промежуточные файлы: для сохранения обработанных данных
   - Копии отчетов: для организованного хранения найденных отчетов
4. **Запустите обработку**: система автоматически:
   - Отфильтрует и сгруппирует данные
   - Найдет соответствующие отчеты по номерам лицензий
   - Скопирует найденные файлы в организованную структуру папок
   - **Заменит данные в скопированных файлах** (🔥 НОВОЕ)

### 📊 Формат промежуточного файла Excel

Промежуточный файл должен содержать столбцы:
- `ח"פ לקוח או מספר עוסק` - номер лицензии
- `אסמכתת בסיס` - базовая ссылка (станет מספר תעודת משלוח)
- `סה'כ אריזות` - общее количество упаковок (станет סה"כ קרטונים)
- `סה'כ משקל` - общий вес (станет מוצרים מוכנים לאכילה)

### Пример поиска отчетов

Система ищет в файлах отчетов Hebrew поля, содержащие номера лицензий:
```
ח"פ לקוח או מספר אישור משרד הבריאות במקרים בהם המשלוח הוא למפעל מאושר: 12345
מספר עוסק מורשה: 67890
```

Найденные отчеты организуются в папки:
```
output/
├── license_12345/
│   └── report_12345.txt
└── license_67890/
    └── report_67890.txt
```

## ✅ Проверка работоспособности

После запуска `test_data_replacement.py` вы должны увидеть:
```
✅ מספר תעודת משלוח: NEW_DELIVERY_NUM (correct)
✅ סה"כ קרטונים: 25 (correct)
✅ מוצרים מוכנים לאכילה: 150.5 (correct)
🎉 All data replacement tests passed!
```

## Разработка

### Статус разработки
✅ **ПОЛНОСТЬЮ ГОТОВО К ИСПОЛЬЗОВАНИЮ**

**Реализованные функции:**
- ✅ GUI интерфейс с поддержкой Hebrew
- ✅ Загрузка и обработка Excel файлов
- ✅ Фильтрация отрицательных значений
- ✅ Конвертация весов (граммы → килограммы)
- ✅ Группировка данных по базовому документу
- ✅ **Интеллектуальный поиск отчетов по содержимому**
- ✅ Поддержка множественных кодировок (UTF-8, Windows-1255, etc.)
- ✅ Обработка Hebrew полей в отчетах
- ✅ Fallback поиск по именам файлов
- ✅ Организованное копирование отчетов
- ✅ **Замена данных в скопированных отчетах** (🔥 ИСПРАВЛЕНО)
- ✅ Детальное логирование операций
- ✅ Сохранение промежуточных файлов

**Тестирование:**
- ✅ Функциональное тестирование ReportManager
- ✅ Тестирование поиска по содержимому
- ✅ Тестирование копирования файлов
- ✅ **Тестирование замены данных** (🔥 ДОБАВЛЕНО)
- ✅ Интеграционное тестирование workflow

## 🐛 Устранение неполадок

1. **Данные не заменяются**: Убедитесь, что промежуточный файл содержит правильные столбцы
2. **Файлы не найдены**: Проверьте, что номера лицензий точно совпадают с содержимым файлов
3. **Ошибки кодировки**: Система автоматически пробует несколько кодировок (UTF-8, Windows-1255, etc.)

## Требования

- Python 3.8+
- tkinter (для GUI)
- pandas (для обработки данных)
- openpyxl (для работы с Excel файлами)
- pytest (для тестирования)

---
**Система протестирована и готова к использованию! ✅**
**Проблема с заменой данных полностью решена! 🔥**
6. Поиска файлов отчетов, содержащих номера лицензий клиентов
7. Подготовки копий для отправки в משרד הבריאות

## Основные функции

### Обработка данных
- **Фильтрация данных**: удаление записей с отрицательными значениями
- **Конвертация весов**: автоматическое преобразование граммов в килограммы
- **Группировка**: объединение данных по базовому документу с суммированием весов и количества

### Интеллектуальный поиск отчетов
- **Поиск по содержимому**: система анализирует содержимое файлов для поиска номеров лицензий
- **Поддержка Hebrew**: обработка полей на иврите, включая "ח"פ לקוח או מספר אישור משרד הבריאות"
- **Множественные кодировки**: UTF-8, Windows-1255, ISO-8859-8, CP1255
- **Форматы файлов**: TXT, JSON, CSV, XML, Excel (.xlsx, .xls)
- **Fallback механизм**: поиск по именам файлов, если поиск по содержимому не даст результатов
- **Организованное копирование**: создание отдельных папок для каждой лицензии

### GUI интерфейс
- **Hebrew текст**: полная поддержка иврита в интерфейсе
- **Выбор папок**: интуитивный выбор исходных файлов и папок отчетов
- **Прогресс выполнения**: отслеживание хода обработки
- **Логирование**: детальные логи операций

## Структура проекта

```
fish-reports-dolina/
├── src/
│   ├── fish_reports/
│   │   ├── __init__.py
│   │   ├── gui/
│   │   │   ├── __init__.py
│   │   │   └── main_window.py
│   │   ├── data/
│   │   │   ├── __init__.py
│   │   │   ├── file_processor.py
│   │   │   └── report_manager.py
│   │   └── utils/
│   │       ├── __init__.py
│   │       └── file_utils.py
├── tests/
├── requirements.txt
├── pyproject.toml
└── README.md
```

## Установка

1. Создайте виртуальное окружение:
```bash
python -m venv venv
```

2. Активируйте виртуальное окружение:
```bash
# Windows
venv\Scripts\activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Запуск

```bash
python -m src.fish_reports
```

## Использование

1. **Выберите исходный файл**: файл Excel с данными о рыбе
2. **Выберите папку отчетов**: директория, содержащая файлы отчетов для поиска
3. **Выберите папки вывода**:
   - Промежуточные файлы: для сохранения обработанных данных
   - Копии отчетов: для организованного хранения найденных отчетов
4. **Запустите обработку**: система автоматически:
   - Отфильтрует и сгруппирует данные
   - Найдет соответствующие отчеты по номерам лицензий
   - Скопирует найденные файлы в организованную структуру папок

### Пример поиска отчетов

Система ищет в файлах отчетов Hebrew поля, содержащие номера лицензий:
```
ח"פ לקוח או מספר אישור משרד הבריאות במקרים בהם המשלוח הוא למפעל מאושר: 12345
מספר עוסק מורשה: 67890
```

Найденные отчеты организуются в папки:
```
output/
├── license_12345/
│   └── report_12345.txt
└── license_67890/
    └── report_67890.txt
```

## Разработка

### Статус разработки
✅ **ПОЛНОСТЬЮ ГОТОВО К ИСПОЛЬЗОВАНИЮ**

**Реализованные функции:**
- ✅ GUI интерфейс с поддержкой Hebrew
- ✅ Загрузка и обработка Excel файлов
- ✅ Фильтрация отрицательных значений
- ✅ Конвертация весов (граммы → килограммы)
- ✅ Группировка данных по базовому документу
- ✅ **Интеллектуальный поиск отчетов по содержимому**
- ✅ Поддержка множественных кодировок (UTF-8, Windows-1255, etc.)
- ✅ Обработка Hebrew полей в отчетах
- ✅ Fallback поиск по именам файлов
- ✅ Организованное копирование отчетов
- ✅ Детальное логирование операций
- ✅ Сохранение промежуточных файлов

**Тестирование:**
- ✅ Функциональное тестирование ReportManager
- ✅ Тестирование поиска по содержимому
- ✅ Тестирование копирования файлов
- ✅ Интеграционное тестирование workflow

### Архитектура
Каждая функция разработана в отдельной ветке:
- `feature/gui-setup` - настройка пользовательского интерфейса ✅
- `feature/file-processing` - обработка файлов ✅
- `feature/data-grouping` - группировка данных ✅
- `feature/report-management` - управление отчетами ✅
- `feature/content-search` - поиск по содержимому ✅

## Требования

- Python 3.8+
- tkinter (для GUI)
- pandas (для обработки данных)
- openpyxl (для работы с Excel файлами)
